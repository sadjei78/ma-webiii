{% extends "base.html" %}

{% block title %}{{ contact.name }} - Contact Manager{% endblock %}
{% block page_title %}{{ contact.name }}{% endblock %}

{% block page_actions %}
<a href="{{ url_for('contacts_list') }}" class="btn btn-outline-secondary me-2">
    <i class="fas fa-arrow-left me-1"></i> Back to List
</a>
<button class="btn btn-outline-primary me-2" onclick="editContact({{ contact.id }})">
    <i class="fas fa-edit me-1"></i> Edit
</button>
<button class="btn btn-outline-danger" onclick="deleteContact({{ contact.id }})">
    <i class="fas fa-trash me-1"></i> Delete
</button>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Contact Information -->
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    {% if contact.important %}
                        <i class="fas fa-star text-warning me-2"></i>
                    {% endif %}
                    Contact Information
                </h5>
                <div>
                    {% if contact.archived %}
                        <span class="badge bg-secondary">Archived</span>
                    {% endif %}
                    <span class="badge bg-primary">{{ contact.category }}</span>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Basic Information</h6>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Name</label>
                            <p class="mb-0">{{ contact.name }}</p>
                        </div>
                        
                        {% if contact.full_name %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Full Name</label>
                            <p class="mb-0">{{ contact.full_name }}</p>
                        </div>
                        {% endif %}
                        
                        {% if contact.organization %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Organization</label>
                            <p class="mb-0">{{ contact.organization }}</p>
                        </div>
                        {% endif %}
                        
                        {% if contact.title %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Title</label>
                            <p class="mb-0">{{ contact.title }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <h6 class="text-muted mb-3">Contact Details</h6>
                        
                        {% if contact.phone_numbers %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Phone Numbers</label>
                            {% for phone in contact.phone_numbers %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-phone text-primary me-2"></i>
                                <span class="me-2">{{ phone.display }}</span>
                                <div class="btn-group btn-group-sm">
                                    <a href="tel:{{ phone.number }}" class="btn btn-outline-primary">
                                        <i class="fas fa-phone"></i>
                                    </a>
                                    <a href="sms:{{ phone.number }}" class="btn btn-outline-success">
                                        <i class="fas fa-sms"></i>
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if contact.emails %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email Addresses</label>
                            {% for email in contact.emails %}
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-envelope text-success me-2"></i>
                                <a href="mailto:{{ email }}" class="email-link">{{ email }}</a>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        {% if contact.url %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">Website</label>
                            <p class="mb-0">
                                <a href="{{ contact.url }}" target="_blank" class="text-decoration-none">
                                    <i class="fas fa-external-link-alt me-1"></i>
                                    {{ contact.url }}
                                </a>
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if contact.address %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Address</h6>
                        <p class="mb-0">{{ contact.address }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if contact.notes %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-muted mb-3">Notes</h6>
                        <p class="mb-0">{{ contact.notes }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h6 class="mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                {% if contact.phone_numbers %}
                <div class="mb-3">
                    <h6 class="text-muted">Call</h6>
                    {% for phone in contact.phone_numbers %}
                    <div class="d-grid gap-2 mb-2">
                        <a href="tel:{{ phone.number }}" class="btn btn-primary">
                            <i class="fas fa-phone me-2"></i>{{ phone.display }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if contact.emails %}
                <div class="mb-3">
                    <h6 class="text-muted">Email</h6>
                    {% for email in contact.emails %}
                    <div class="d-grid gap-2 mb-2">
                        <a href="mailto:{{ email }}" class="btn btn-success">
                            <i class="fas fa-envelope me-2"></i>{{ email }}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <h6 class="text-muted">Manage</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-warning" onclick="toggleImportant({{ contact.id }})">
                            <i class="fas fa-star me-2"></i>
                            {% if contact.important %}Remove from Important{% else %}Mark as Important{% endif %}
                        </button>
                        <button class="btn btn-outline-secondary" onclick="toggleArchived({{ contact.id }})">
                            <i class="fas fa-archive me-2"></i>
                            {% if contact.archived %}Unarchive{% else %}Archive{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contact History -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0">Contact History</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted">Created:</small><br>
                    <small>{{ contact.created_date[:10] if contact.created_date else 'Unknown' }}</small>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Last Modified:</small><br>
                    <small>{{ contact.last_modified[:10] if contact.last_modified else 'Unknown' }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div class="modal fade" id="editContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editContactForm">
                    <input type="hidden" id="editContactId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editContactName" class="form-label">Name *</label>
                                <input type="text" class="form-control" id="editContactName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editContactFullName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="editContactFullName">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editContactOrganization" class="form-label">Organization</label>
                                <input type="text" class="form-control" id="editContactOrganization">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editContactTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="editContactTitle">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editContactCategory" class="form-label">Category</label>
                                <select class="form-select" id="editContactCategory">
                                    <option value="Uncategorized">Uncategorized</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editContactImportant">
                                    <label class="form-check-label" for="editContactImportant">
                                        Mark as Important
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editContactArchived">
                                    <label class="form-check-label" for="editContactArchived">
                                        Archive Contact
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editContactAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="editContactAddress" rows="2"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editContactNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editContactNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedContact()">Save Changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function editContact(contactId) {
    // Load contact data and open edit modal
    fetch(`/api/contacts`)
        .then(response => response.json())
        .then(contacts => {
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                // Populate edit form
                document.getElementById('editContactId').value = contact.id;
                document.getElementById('editContactName').value = contact.name;
                document.getElementById('editContactFullName').value = contact.full_name || '';
                document.getElementById('editContactOrganization').value = contact.organization || '';
                document.getElementById('editContactTitle').value = contact.title || '';
                document.getElementById('editContactAddress').value = contact.address || '';
                document.getElementById('editContactNotes').value = contact.notes || '';
                document.getElementById('editContactCategory').value = contact.category;
                document.getElementById('editContactImportant').checked = contact.important;
                document.getElementById('editContactArchived').checked = contact.archived;
                
                // Open edit modal
                const editModal = new bootstrap.Modal(document.getElementById('editContactModal'));
                editModal.show();
            }
        });
}

function saveEditedContact() {
    const contactId = document.getElementById('editContactId').value;
    const formData = {
        id: parseInt(contactId),
        name: document.getElementById('editContactName').value,
        full_name: document.getElementById('editContactFullName').value,
        organization: document.getElementById('editContactOrganization').value,
        title: document.getElementById('editContactTitle').value,
        address: document.getElementById('editContactAddress').value,
        notes: document.getElementById('editContactNotes').value,
        category: document.getElementById('editContactCategory').value,
        important: document.getElementById('editContactImportant').checked,
        archived: document.getElementById('editContactArchived').checked
    };

    fetch('/api/contacts', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(document.getElementById('editContactModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error updating contact');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating contact');
    });
}

function toggleImportant(contactId) {
    fetch('/api/contacts')
        .then(response => response.json())
        .then(contacts => {
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                contact.important = !contact.important;
                updateContact(contact);
            }
        });
}

function toggleArchived(contactId) {
    fetch('/api/contacts')
        .then(response => response.json())
        .then(contacts => {
            const contact = contacts.find(c => c.id === contactId);
            if (contact) {
                contact.archived = !contact.archived;
                updateContact(contact);
            }
        });
}

function updateContact(contact) {
    fetch('/api/contacts', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(contact)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Error updating contact');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating contact');
    });
}

function deleteContact(contactId) {
    if (confirm('Are you sure you want to delete this contact?')) {
        fetch(`/api/contacts?id=${contactId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                window.location.href = '{{ url_for("contacts_list") }}';
            } else {
                alert('Error deleting contact');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting contact');
        });
    }
}

// Load categories for edit form
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/categories')
        .then(response => response.json())
        .then(categories => {
            const select = document.getElementById('editContactCategory');
            select.innerHTML = '<option value="Uncategorized">Uncategorized</option>';
            categories.forEach(category => {
                if (category !== 'Uncategorized') {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                }
            });
        });
});
</script>
{% endblock %} 